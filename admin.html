<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Survey Insights Dashboard</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #eef2ff;
        --surface: #ffffff;
        --card: rgba(255, 255, 255, 0.9);
        --text: #1f2a44;
        --muted: #7c88b0;
        --accent: #6c7ae0;
        --accent-strong: #4c56c0;
        --border: rgba(31, 42, 68, 0.1);
        font-family: "Inter", "PingFang SC", "Microsoft YaHei", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: radial-gradient(circle at top, #fdf2ff 0%, #e4edff 40%, var(--bg) 100%);
        color: var(--text);
        padding: 30px 18px 60px;
      }

      .page {
        max-width: 1180px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      header {
        background: var(--surface);
        border-radius: 28px;
        padding: 28px 32px;
        border: 1px solid var(--border);
        box-shadow: 0 30px 60px rgba(31, 42, 68, 0.1);
        display: flex;
        justify-content: space-between;
        gap: 18px;
        flex-wrap: wrap;
      }

      header h1 {
        margin: 0;
        font-size: 1.6rem;
      }

      header p {
        margin: 6px 0 0;
        color: var(--muted);
      }

      .actions {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }

      button {
        border: none;
        cursor: pointer;
        border-radius: 18px;
        padding: 12px 20px;
        font-weight: 600;
        font-size: 0.95rem;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .primary {
        background: linear-gradient(120deg, #6c7ae0, #8da2fb);
        color: #fff;
        box-shadow: 0 15px 30px rgba(108, 122, 224, 0.35);
      }

      .primary:disabled {
        opacity: 0.5;
        cursor: wait;
      }

      .ghost {
        background: transparent;
        border: 1px dashed var(--accent);
        color: var(--accent-strong);
      }

      .grid {
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .card {
        background: var(--card);
        border-radius: 24px;
        padding: 24px;
        border: 1px solid var(--border);
        box-shadow: 0 15px 40px rgba(31, 42, 68, 0.08);
      }

      .card h2 {
        margin-top: 0;
        font-size: 1.1rem;
      }

      .question-card + .question-card {
        margin-top: 18px;
      }

      .meta {
        color: var(--muted);
        font-size: 0.9rem;
        margin-bottom: 14px;
      }

      .bar {
        height: 8px;
        border-radius: 999px;
        background: rgba(108, 122, 224, 0.2);
        overflow: hidden;
        margin-top: 6px;
      }

      .bar span {
        display: block;
        height: 100%;
        background: linear-gradient(120deg, #6c7ae0, #8da2fb);
      }

      .option-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        font-size: 0.95rem;
      }

      .option-row strong {
        color: var(--accent-strong);
      }

      .text-feed {
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-height: 360px;
        overflow-y: auto;
        border-radius: 20px;
        padding-right: 4px;
      }

      .text-entry {
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 14px 16px;
        background: #fff;
      }

      .text-entry time {
        display: block;
        font-size: 0.85rem;
        color: var(--muted);
        margin-bottom: 6px;
      }

      .loader {
        text-align: center;
        color: var(--muted);
      }

      .error {
        color: #c53030;
        background: rgba(255, 67, 86, 0.08);
        border: 1px solid rgba(255, 67, 86, 0.3);
        padding: 12px 16px;
        border-radius: 16px;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header>
        <div>
          <h1>Survey Insights Dashboard</h1>
          <p>
            Consolidated view of every submission from Supabase. Refresh anytime to pull the latest
            answers.
          </p>
        </div>
        <div class="actions">
          <button class="primary" id="refresh-btn">Refresh data</button>
          <button class="ghost" id="export-btn">Download CSV</button>
        </div>
      </header>

      <section class="card">
        <h2>Summary</h2>
        <p class="meta" id="summary-meta">Loading submissions…</p>
        <div class="grid" id="summary-grid"></div>
      </section>

      <section class="card">
        <h2>Question breakdown</h2>
        <p class="meta">Counts are based on all recorded submissions from Supabase.</p>
        <div id="question-grid" class="grid loader">Loading…</div>
      </section>

      <section class="card">
        <h2>Open responses</h2>
        <p class="meta">Newest 20 responses for each open-ended question.</p>
        <div id="text-feed" class="text-feed loader">Loading…</div>
      </section>
    </div>

    <script>
      const SUPABASE_URL = "https://tgckygkqjdihvdazqwqe.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnY2t5Z2txamRpaHZkYXpxd3FlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4OTc1MjksImV4cCI6MjA3ODQ3MzUyOX0.GKcnJIL3Ffyj9HljHJqeWObuFOFImnUbCY5rZ8V9BHw";
      const SUPABASE_RESPONSES_ENDPOINT = `${SUPABASE_URL}/rest/v1/survey_responses`;
      const supabaseHeaders = {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`,
        "Content-Type": "application/json"
      };

      const questionSections = [
        { id: "basic", title: "Basic information" },
        { id: "purchase", title: "Purchase behavior" },
        { id: "usage", title: "Usage & idle toys" },
        { id: "sustainability", title: "Sustainability awareness" },
        { id: "reuse", title: "Reuse, recycling & donation" },
        { id: "open", title: "Open questions" }
      ];

      const questions = [
        {
          id: "basic-age",
          sectionId: "basic",
          type: "single",
          text: "Your age range",
          options: [
            { value: "18-23", label: "18–23" },
            { value: "23-30", label: "23–30" },
            { value: "30-36", label: "30–36" },
            { value: "36-44", label: "36–44" }
          ]
        },
        {
          id: "basic-gender",
          sectionId: "basic",
          type: "single",
          text: "Gender",
          options: [
            { value: "male", label: "Male" },
            { value: "female", label: "Female" },
            { value: "gender-other", label: "Other / prefer not to say" }
          ]
        },
        {
          id: "basic-occupation",
          sectionId: "basic",
          type: "single",
          text: "Occupation / role",
          options: [
            { value: "student", label: "Student" },
            { value: "office-worker", label: "Office worker" },
            { value: "freelancer", label: "Freelancer" },
            { value: "occupation-other", label: "Other (custom)" }
          ]
        },
        {
          id: "basic-pet-type",
          sectionId: "basic",
          type: "multi",
          text: "Pet type(s)",
          options: [
            { value: "dog", label: "Dog" },
            { value: "cat", label: "Cat" },
            { value: "pet-other", label: "Other (custom)" }
          ]
        },
        {
          id: "basic-children",
          sectionId: "basic",
          type: "single",
          text: "Do you have children?",
          options: [
            { value: "yes", label: "Yes" },
            { value: "no", label: "No" }
          ]
        },
        {
          id: "purchase-frequency",
          sectionId: "purchase",
          type: "single",
          text: "How often do you buy toys?",
          options: [
            { value: "monthly", label: "More than once / month" },
            { value: "quarterly", label: "Once in 2–3 months" },
            { value: "half-year", label: "Every 6 months" },
            { value: "yearly", label: "Once a year or less" }
          ]
        },
        {
          id: "purchase-channels",
          sectionId: "purchase",
          type: "multi",
          text: "Purchase channels",
          options: [
            { value: "ecommerce", label: "E-commerce platforms" },
            { value: "offline", label: "Offline pet store" },
            { value: "social", label: "Social platforms" },
            { value: "brand-site", label: "Brand website" },
            { value: "channel-other", label: "Other (custom)" }
          ]
        },
        {
          id: "purchase-motivation",
          sectionId: "purchase",
          type: "multi",
          text: "Motivations to buy",
          options: [
            { value: "replace", label: "Replacing broken toys" },
            { value: "fun", label: "Keep my pet happy" },
            { value: "influenced", label: "Influenced by social media" },
            { value: "festival", label: "Holiday / gift" },
            { value: "self-love", label: "I find the toy cute" },
            { value: "motivation-other", label: "Other (custom)" }
          ]
        },
        {
          id: "usage-idle-handling",
          sectionId: "usage",
          type: "multi",
          text: "Handle idle/damaged toys",
          options: [
            { value: "discard", label: "Discard" },
            { value: "store", label: "Store away" },
            { value: "repurpose", label: "Repurpose" },
            { value: "clean", label: "Clean & reuse" },
            { value: "donate", label: "Donate" },
            { value: "idle-other", label: "Other (custom)" }
          ]
        },
        {
          id: "sustainability-premium",
          sectionId: "sustainability",
          type: "single",
          text: "Pay 20% premium for eco toys?",
          options: [
            { value: "yes", label: "Yes" },
            { value: "depends", label: "Depends" },
            { value: "no", label: "No" }
          ]
        },
        {
          id: "reuse-participation",
          sectionId: "reuse",
          type: "single",
          text: "Join recycle/reuse program?",
          options: [
            { value: "definitely", label: "Definitely" },
            { value: "maybe", label: "Likely" },
            { value: "depends", label: "Depends on details" },
            { value: "wont", label: "Probably not" }
          ]
        },
        {
          id: "reuse-factors",
          sectionId: "reuse",
          type: "multi",
          text: "Factors to join reuse program",
          options: [
            { value: "convenience", label: "Convenience" },
            { value: "hygiene", label: "Hygiene / safety" },
            { value: "quantity", label: "Idle toys at home" },
            { value: "price", label: "Service fee" },
            { value: "trust", label: "Trust in organizer" },
            { value: "reward", label: "Rewards / incentives" },
            { value: "responsibility", label: "Environmental responsibility" },
            { value: "reuse-other", label: "Other (custom)" }
          ]
        },
        {
          id: "open-waste",
          sectionId: "open",
          type: "text",
          text: "What feels most wasteful unsustainable?"
        },
        {
          id: "open-innovation",
          sectionId: "open",
          type: "text",
          text: "What improvements do you hope to see?"
        }
      ];

      const questionMap = new Map(questions.map((q) => [q.id, q]));

      const formatTimestamp = (value) => {
        try {
          return new Intl.DateTimeFormat("en-US", {
            year: "numeric",
            month: "short",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit"
          }).format(new Date(value));
        } catch (error) {
          return value;
        }
      };

      const downloadCSV = (records) => {
        if (!records.length) return;
        const rows = records.map((record) => ({
          submitted_at: record.submitted_at,
          answers: JSON.stringify(record.answers)
        }));
        const header = Object.keys(rows[0]).join(",");
        const body = rows
          .map((row) => Object.values(row).map((value) => `"${String(value).replace(/"/g, '""')}"`).join(","))
          .join("\n");
        const blob = new Blob([`${header}\n${body}`], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `survey-responses-${new Date().toISOString().slice(0, 10)}.csv`;
        link.click();
        URL.revokeObjectURL(url);
      };

      const aggregateResponses = (records) => {
        const totals = {};
        const textAnswers = {};
        records.forEach((record) => {
          const answers = record.answers || {};
          Object.entries(answers).forEach(([questionId, payload]) => {
            const question = questionMap.get(questionId);
            if (!question || !payload) return;
            if (question.type === "single") {
              totals[questionId] = totals[questionId] || {};
              const optionKey = payload.selection;
              if (!optionKey) return;
              totals[questionId][optionKey] = (totals[questionId][optionKey] || 0) + 1;
            } else if (question.type === "multi") {
              totals[questionId] = totals[questionId] || {};
              (payload.selections || []).forEach((selection) => {
                totals[questionId][selection] = (totals[questionId][selection] || 0) + 1;
              });
            } else if (question.type === "text") {
              textAnswers[questionId] = textAnswers[questionId] || [];
              if (payload.text) {
                textAnswers[questionId].push({
                  text: payload.text,
                  submitted_at: record.submitted_at
                });
              }
            }
          });
        });
        return { totals, textAnswers };
      };

      const renderSummary = (records) => {
        const meta = document.getElementById("summary-meta");
        const grid = document.getElementById("summary-grid");
        if (!meta || !grid) return;
        if (!records.length) {
          meta.textContent = "No submissions yet.";
          grid.innerHTML = "";
          return;
        }
        meta.textContent = `Total ${records.length} submissions · Last updated ${formatTimestamp(records[0].submitted_at)}`;
        const latest = records.slice(0, 5);
        grid.innerHTML = latest
          .map(
            (record) => `
              <div class="option-row">
                <strong>${formatTimestamp(record.submitted_at)}</strong>
                <span>${Object.keys(record.answers || {}).length} answered fields</span>
              </div>
            `
          )
          .join("");
      };

      const renderQuestionBreakdown = (totals) => {
        const grid = document.getElementById("question-grid");
        if (!grid) return;
        if (!Object.keys(totals).length) {
          grid.textContent = "No quantitative responses yet.";
          return;
        }
        grid.innerHTML = "";
        questionSections.forEach((section) => {
          const sectionQuestions = questions.filter((question) => question.sectionId === section.id);
          sectionQuestions.forEach((question) => {
            if (question.type === "text") return;
            const card = document.createElement("div");
            card.className = "question-card card";
            const title = document.createElement("h2");
            title.textContent = question.text;
            card.appendChild(title);
            const counts = totals[question.id] || {};
            const totalCount = Object.values(counts).reduce((sum, value) => sum + value, 0);
            const meta = document.createElement("p");
            meta.className = "meta";
            meta.textContent = totalCount ? `${totalCount} selections` : "No answers yet";
            card.appendChild(meta);
            (question.options || []).forEach((option) => {
              const count = counts[option.value] || 0;
              const percent = totalCount ? Math.round((count / totalCount) * 100) : 0;
              const row = document.createElement("div");
              row.className = "option-row";
              row.innerHTML = `<span>${option.label}</span><strong>${count} · ${percent}%</strong>`;
              card.appendChild(row);
              const bar = document.createElement("div");
              bar.className = "bar";
              const span = document.createElement("span");
              span.style.width = `${percent}%`;
              bar.appendChild(span);
              card.appendChild(bar);
            });
            grid.appendChild(card);
          });
        });
      };

      const renderOpenResponses = (textAnswers) => {
        const feed = document.getElementById("text-feed");
        if (!feed) return;
        feed.innerHTML = "";
        const entries = [];
        Object.entries(textAnswers).forEach(([questionId, answers]) => {
          const question = questionMap.get(questionId);
          (answers || [])
            .slice(0, 20)
            .forEach((answer) => entries.push({ question: question?.text || questionId, ...answer }));
        });
        if (!entries.length) {
          feed.textContent = "No open-ended responses yet.";
          return;
        }
        entries
          .sort((a, b) => new Date(b.submitted_at) - new Date(a.submitted_at))
          .forEach((entry) => {
            const item = document.createElement("article");
            item.className = "text-entry";
            item.innerHTML = `
              <time>${formatTimestamp(entry.submitted_at)}</time>
              <strong>${entry.question}</strong>
              <p>${entry.text.replace(/\n/g, "<br/>")}</p>
            `;
            feed.appendChild(item);
          });
      };

      const refreshButton = document.getElementById("refresh-btn");
      const exportButton = document.getElementById("export-btn");
      let cachedRecords = [];

      const loadResponses = async () => {
        if (refreshButton) refreshButton.disabled = true;
        try {
          const params = new URLSearchParams({
            select: "answers,submitted_at",
            order: "submitted_at.desc",
            limit: "500"
          });
          const response = await fetch(`${SUPABASE_RESPONSES_ENDPOINT}?${params.toString()}`, {
            headers: supabaseHeaders
          });
          if (!response.ok) {
            throw new Error(`Failed to fetch responses: ${response.status}`);
          }
          const data = await response.json();
          cachedRecords = Array.isArray(data) ? data : [];
          renderSummary(cachedRecords);
          const { totals, textAnswers } = aggregateResponses(cachedRecords);
          renderQuestionBreakdown(totals);
          renderOpenResponses(textAnswers);
        } catch (error) {
          const grid = document.getElementById("question-grid");
          const feed = document.getElementById("text-feed");
          if (grid) grid.innerHTML = `<p class="error">${error.message}</p>`;
          if (feed) feed.innerHTML = `<p class="error">${error.message}</p>`;
        } finally {
          if (refreshButton) refreshButton.disabled = false;
        }
      };

      if (refreshButton) {
        refreshButton.addEventListener("click", loadResponses);
      }

      if (exportButton) {
        exportButton.addEventListener("click", () => downloadCSV(cachedRecords));
      }

      loadResponses();
    </script>
  </body>
</html>
